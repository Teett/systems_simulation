---
title: "Simulación de Sistemas - León XIII"
author: "Daniel"
date: "21/2/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries

```{r}
library(tidyverse)
library(fitdistrplus)
library(lubridate)
```

# Data reading

Admision office dynamics could be hidden inside the data repetition, need to further assess.

```{r}


datos_complementarios <- read_csv2("datasets/tiempos_ingresos_15k.csv", locale = readr::locale(encoding = "latin1")) %>% 
  mutate(servicio = as_factor(servicio),
         servicio_detalle = as_factor(servicio_detalle),
         nivelPrioridad = as_factor(nivelPrioridad)) %>% 
  mutate_at(vars(salida_taquilla, entrada_triage, fin_triage, entrada_servicio, salida_servicio), as_datetime)

raw_data <- read_csv("datasets/tiempos_ingresos_10k.csv") %>% 
  inner_join(datos_complementarios %>%
               distinct(atencion, .keep_all = TRUE) %>% 
              dplyr::select(atencion, nivelPrioridad))

```

## Study Interval

```{r}
raw_data %>%
  summarize(min(entrada_triage))

raw_data %>%
  ggplot(aes(x = entrada_triage, fill = servicio)) +
  geom_histogram(bins = 44, color = "black") +
  labs(title = "Intervalo del estudio realizado por servicio")
```

Interval: 2020-01-07 12:51:12 to 2020-02-21 17:00:00

## Hourly distribution by service

```{r}
raw_data %>%
  ggplot(aes(x = hour(entrada_triage), fill = servicio)) +
  geom_histogram(bins = 44, color = "black") +
  labs(title = "Horas más concurridas por servicio")
```

# Creation of the duration of events

```{r}
clean_data <- raw_data %>%
  distinct(salida_taquilla, .keep_all = TRUE)

tiempo_llegadas <- diff(sort(clean_data$salida_taquilla))

tiempos <- clean_data %>% 
  mutate(cola_triage = entrada_triage - salida_taquilla,
         dur_triage = fin_triage - entrada_triage,
         cola_servicio = entrada_servicio - fin_triage,
         dur_servicio = salida_servicio - entrada_servicio) %>%
  mutate_at(vars(cola_triage, dur_triage, cola_servicio, dur_servicio), as.numeric) %>% 
  dplyr::select(atencion, servicio, servicio_detalle, cola_triage, 
                dur_triage, cola_servicio, dur_servicio) %>%
  filter_if(is.numeric, all_vars(. > 10)) %>% # Validado con asistenciales
  filter(cola_triage <= 14400, # Hasta 4 horas, validado con doctores de urgencias 
         cola_servicio <= 43200) # Hasta 24 horas, validado con asistenciales
```

## A tidy version of the clean data

```{r}
tidy_tiempos <- tiempos %>% 
  pivot_longer(cols = 4:7,
               names_to = "clase",
               values_to = "valor")

tidy_tiempos
```

## Considerations

- All the durations considered will last at least 30 seconds.
- Triage queues higher than 12 hours will be discarded, the same goes for service time queues higher than 36 hours.

# Correlations and density plots

```{r}
tiempos %>%
  GGally::ggpairs(mapping = aes(alpha = 0.6), columns = 4:7)
```

All the event lengths seem to be uncorrelated with each other. At first glance some negative exponential distributions may appear.

# Descriptive statistics

```{r}
tiempos %>% 
  summary()
```

## Histograms

```{r}
tidy_tiempos %>%
  filter(clase != "cola_triage", clase != "dur_triage") %>% 
  ggplot(aes(x = valor, fill = clase)) +
  geom_histogram(color = "black", bins = 60) +
  facet_wrap(~servicio + clase, scales = "free", ncol = 2) +
  scale_x_continuous(labels = scales::comma) +
  labs(title = "Distribuciones de los tiempos de cola y duraciones en los servicios")
  

tidy_tiempos %>%
  filter(clase == "cola_triage" | clase == "dur_triage") %>% 
  ggplot(aes(x = valor, fill = clase)) +
  geom_histogram(color = "black", bins = 60) +
  facet_wrap(~clase, scales = "free", nrow = 2) +
  scale_x_continuous(labels = scales::comma) +
  scale_fill_brewer(palette = "Dark2") +
  labs(title = "Distribuciones del tiempo en cola y la duración del triage")
```


# Distribution selection

```{r}
cullen_fray <- map(tiempos[,c(5,7)], descdist, discrete = FALSE, boot = 1000)
cullen_fray_llegadas <- descdist(as.numeric(tiempo_llegadas), boot = 1000)
```

Distributions will only be fitted to the duration of the services, as the queues are of no interest, but rather an output of the discrete event simulation.

# Distribution fitting

## Triage duration

Exponential distribution, gamma distribution and lognormal distribution are good candiadates for the data based on the kurtosis (`r cullen_fray$dur_triage$kurtosis`) and skewness (`r cullen_fray$dur_triage$skewness`) of the data. 

### Exponential distribution

```{r}
fit_triage_exp <- fitdist(tiempos$dur_triage, distr = "exp", method = "mle")
fit_triage_exp
plot(fit_triage_exp)
```

Null hyphotesis rejected based on the Q-Q plot, the data can't possibly be represented by an exponential distribution.

### Gamma distribution

```{r}
fit_triage_gamma <- fitdist(tiempos$dur_triage, distr = "gamma", method = "mle")
fit_triage_gamma
plot(fit_triage_gamma)
```

Null hyphotesis could be rejected, need further testing.

### Lognormal

```{r}
fit_triage_lognormal <- fitdist(tiempos$dur_triage, distr = "lnorm", method = "mle")
fit_triage_lognormal
plot(fit_triage_lognormal)
```

Data is definitely lognormal, need to conduct formal hypothesis testing here.

## Service duration

The services are individual, so an aggregation of these doesn't seem appropiate at all. The individual services are:

```{r, echo=FALSE}
tiempos %>% 
  count(servicio_detalle, sort = T)
```

A general try anyway:

Gamma distribution and lognormal distribution could be good candiadates for the data based on the kurtosis (`r cullen_fray$dur_servicio$kurtosis`) and skewness (`r cullen_fray$dur_servicio$skewness`) of the data using Cullen and Frey's graphical method.  

### Gamma distribution

Need an scaling factor for the gamma to work, **need to reference this.**

```{r}
fit_servicio_gamma <- fitdist(tiempos$dur_servicio/250, distr = "gamma", method = "mle")
fit_servicio_gamma
plot(fit_servicio_gamma)
```

Gamma distribution doesn't seem to work very well with this data. May need more tunning. 

### Lognormal distribution

```{r}
fit_servicio_lognormal <- fitdist(tiempos$dur_servicio, distr = "lnorm", method = "mle")
fit_servicio_lognormal
plot(fit_servicio_lognormal)
```

Lognormal distribution may work, need further verification. Theorically there is no distribution that can fit these data, as there are distinguishable categories that behave differently inside the data. Separation by service is needed.

## Camillas SAI Adultos

```{r}
tiempos_SAI <- tiempos %>% 
  filter(servicio_detalle == "Camillas SAI Adultos")

descdist(as.numeric(tiempos_SAI$dur_servicio), boot = 500)
```

### Exponential

```{r}
fit_SAI_exp <- fitdist(tiempos_SAI$dur_servicio/250, distr = "exp", method = "mle")
fit_SAI_exp
plot(fit_SAI_exp)
```

### Lognormal

```{r}
fit_SAI_lognormal <- fitdist(tiempos_SAI$dur_servicio, distr = "lnorm", method = "mle")
fit_SAI_lognormal
plot(fit_SAI_lognormal)
```

### Gamma distribution

Need an scaling factor for the gamma to work, **need to reference this.**

```{r}
fit_SAI_gamma <- fitdist(tiempos_SAI$dur_servicio/250, distr = "gamma", method = "mle")
fit_SAI_gamma
plot(fit_SAI_gamma)
```

SAI seems to be Gamma!

## Traumas Urgencias

```{r}
tiempos_trauma <- tiempos %>% 
  filter(servicio_detalle == "Traumas Urgencias")

descdist(as.numeric(tiempos_trauma$dur_servicio), boot = 500)
```

### Exponential

```{r}
fit_trauma_exp <- fitdist(tiempos_trauma$dur_servicio/250, distr = "exp", method = "mle")
fit_trauma_exp
plot(fit_trauma_exp)
```

No.

### Lognormal

```{r}
fit_trauma_lognormal <- fitdist(tiempos_trauma$dur_servicio, distr = "lnorm", method = "mle")
fit_trauma_lognormal
plot(fit_trauma_lognormal)
```

No.

### Gamma distribution

Need an scaling factor for the gamma to work, **need to reference this.**

```{r}
fit_trauma_gamma <- fitdist(tiempos_trauma$dur_servicio/250, distr = "gamma", method = "mle")
fit_trauma_gamma
plot(fit_trauma_gamma)
```

No.

## ERA Pediatria

```{r}
tiempos_pediatria <- tiempos %>% 
  filter(servicio_detalle == "ERA Pediatria")

descdist(as.numeric(tiempos_pediatria$dur_servicio), boot = 500)
```

### Exponential

```{r}
fit_pediatria_exp <- fitdist(tiempos_pediatria$dur_servicio/250, distr = "exp", method = "mle")
fit_pediatria_exp
plot(fit_pediatria_exp)
```

No.

### Lognormal

```{r}
fit_pediatria_lognormal <- fitdist(tiempos_pediatria$dur_servicio, distr = "lnorm", method = "mle")
fit_pediatria_lognormal
plot(fit_pediatria_lognormal)
```

Parece que sí

### Gamma distribution

Need an scaling factor for the gamma to work, **need to reference this.**

```{r}
fit_pediatria_gamma <- fitdist(tiempos_pediatria$dur_servicio/250, distr = "gamma", method = "mle")
fit_pediatria_gamma
plot(fit_pediatria_gamma)
```

No.


# Saving the data

```{r}
write_csv(tiempos, "datasets/tiempos.csv")
write_lines(tiempo_llegadas, "datasets/tiempo_llegadas.txt")
```

